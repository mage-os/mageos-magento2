<?xml version="1.0" encoding="UTF-8"?>
<!--
/**
 * Copyright 2025 Adobe
 * All Rights Reserved.
 */
-->
<tests xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:noNamespaceSchemaLocation="urn:magento:mftf:Test/etc/testSchema.xsd">
    <test name="StorefrontValidatePriceChangesForConfigurableProductWithMultipleAttributesInWidgetTest">
        <annotations>
            <features value="Catalog"/>
            <stories value="Product Price Display"/>
            <title value="Validate price changes for configurable product with dropdown and text swatch attributes on storefront"/>
            <description value="Create dropdown and text swatch attributes, create two configurable products with different attribute combinations, and validate price changes on storefront product page"/>
            <testCaseId value="AC-8423"/>
            <severity value="MAJOR"/>
            <group value="Catalog"/>
            <group value="ConfigurableProduct"/>
        </annotations>
        <before>
            <!-- Step-1: Login to admin -->
            <actionGroup ref="AdminLoginActionGroup" stepKey="loginAsAdmin"/>
            <!-- Create category for products -->
            <createData entity="_defaultCategory" stepKey="createCategory"/>
            <!-- Step-2: Create a dropdown product attribute with three options -->
            <actionGroup ref="AdminNavigateToNewProductAttributePageActionGroup" stepKey="goToNewProductAttributePage"/>
            <actionGroup ref="AdminFillProductAttributePropertiesActionGroup" stepKey="fillAttributeProperties">
                <argument name="attributeName" value="{{DropdownSizeAttributeData.frontend_label}}"/>
                <argument name="attributeType" value="{{DropdownSizeAttributeData.attribute_type}}"/>
            </actionGroup>
            <click selector="{{AttributePropertiesSection.AdvancedProperties}}" stepKey="clickAdvancedProperties"/>
            <fillField selector="{{AttributePropertiesSection.AttributeCode}}" userInput="{{DropdownSizeAttributeData.attribute_code}}" stepKey="fillAttributeCode"/>
            <selectOption selector="{{AttributePropertiesSection.Scope}}" userInput="{{DropdownSizeAttributeData.scope}}" stepKey="selectGlobalScope"/>
            <click selector="{{AttributePropertiesSection.dropdownAddOptions}}" stepKey="clickAddOption1"/>
            <fillField selector="{{AttributePropertiesSection.dropdownNthOptionAdmin('1')}}" userInput="{{AttributeOptionSmall.value}}" stepKey="fillOption1Admin"/>
            <click selector="{{AttributePropertiesSection.dropdownAddOptions}}" stepKey="clickAddOption2"/>
            <fillField selector="{{AttributePropertiesSection.dropdownNthOptionAdmin('2')}}" userInput="{{AttributeOptionMedium.value}}" stepKey="fillOption2Admin"/>
            <click selector="{{AttributePropertiesSection.dropdownAddOptions}}" stepKey="clickAddOption3"/>
            <fillField selector="{{AttributePropertiesSection.dropdownNthOptionAdmin('3')}}" userInput="{{AttributeOptionLarge.value}}" stepKey="fillOption3Admin"/>
            <actionGroup ref="AdminProductAttributeSaveActionGroup" stepKey="saveDropdownAttribute"/>
            <!-- Step-3: Create a text swatch product attribute with three options -->
            <actionGroup ref="AdminNavigateToNewProductAttributePageActionGroup" stepKey="goToNewProductAttributePageForSwatch"/>
            <actionGroup ref="AdminFillProductAttributePropertiesActionGroup" stepKey="fillSwatchAttributeProperties">
                <argument name="attributeName" value="{{TextSwatchColorAttributeData.frontend_label}}"/>
                <argument name="attributeType" value="{{TextSwatchColorAttributeData.attribute_type}}"/>
            </actionGroup>
            <click selector="{{AttributePropertiesSection.AdvancedProperties}}" stepKey="clickAdvancedPropertiesForSwatch"/>
            <fillField selector="{{AttributePropertiesSection.AttributeCode}}" userInput="{{TextSwatchColorAttributeData.attribute_code}}" stepKey="fillSwatchAttributeCode"/>
            <selectOption selector="{{AttributePropertiesSection.Scope}}" userInput="{{TextSwatchColorAttributeData.scope}}" stepKey="selectGlobalScopeForSwatch"/>
            <click selector="{{AdminManageSwatchSection.addSwatchText}}" stepKey="clickAddSwatchOption1"/>
            <fillField selector="{{AdminManageSwatchSection.swatchTextByIndex('0')}}" userInput="{{AttributeOptionBlack.value}}" stepKey="fillSwatchOption1"/>
            <fillField selector="{{AdminManageSwatchSection.swatchAdminDescriptionByIndex('0')}}" userInput="{{AttributeOptionBlack.value}}" stepKey="fillSwatchOption1Description"/>
            <click selector="{{AdminManageSwatchSection.addSwatchText}}" stepKey="clickAddSwatchOption2"/>
            <fillField selector="{{AdminManageSwatchSection.swatchTextByIndex('1')}}" userInput="{{AttributeOptionWhite.value}}" stepKey="fillSwatchOption2"/>
            <fillField selector="{{AdminManageSwatchSection.swatchAdminDescriptionByIndex('1')}}" userInput="{{AttributeOptionWhite.value}}" stepKey="fillSwatchOption2Description"/>
            <click selector="{{AdminManageSwatchSection.addSwatchText}}" stepKey="clickAddSwatchOption3"/>
            <fillField selector="{{AdminManageSwatchSection.swatchTextByIndex('2')}}" userInput="{{AttributeOptionBlue.value}}" stepKey="fillSwatchOption3"/>
            <fillField selector="{{AdminManageSwatchSection.swatchAdminDescriptionByIndex('2')}}" userInput="{{AttributeOptionBlue.value}}" stepKey="fillSwatchOption3Description"/>
            <actionGroup ref="AdminProductAttributeSaveActionGroup" stepKey="saveTextSwatchAttribute"/>
            <!-- Create configurable products via API -->
            <createData entity="ApiConfigurableProduct" stepKey="createConfigProduct1">
                <requiredEntity createDataKey="createCategory"/>
                <field key="name">Conf 1</field>
                <field key="sku">conf-1</field>
                <field key="price">100</field>
            </createData>
            <createData entity="ApiConfigurableProduct" stepKey="createConfigProduct2">
                <requiredEntity createDataKey="createCategory"/>
                <field key="name">Conf 2</field>
                <field key="sku">conf-2</field>
                <field key="price">200</field>
            </createData>
        </before>
        <after>
            <!-- Delete category -->
            <deleteData createDataKey="createCategory" stepKey="deleteCategory"/>
            <!-- Delete created products -->
            <actionGroup ref="DeleteAllProductsUsingProductGridActionGroup" stepKey="deleteAllProducts"/>
            <!-- Delete widget -->
            <actionGroup ref="AdminDeleteWidgetActionGroup" stepKey="deleteWidget">
                <argument name="widget" value="SampleCatalogProductsListWidget"/>
            </actionGroup>
            <!-- Delete dropdown attribute -->
            <actionGroup ref="DeleteProductAttributeByCodeActionGroup" stepKey="deleteDropdownAttribute">
                <argument name="attribute_code" value="{{DropdownSizeAttributeData.attribute_code}}"/>
            </actionGroup>
            <!-- Delete text swatch attribute -->
            <actionGroup ref="DeleteProductAttributeByCodeActionGroup" stepKey="deleteSwatchAttribute">
                <argument name="attribute_code" value="{{TextSwatchColorAttributeData.attribute_code}}"/>
            </actionGroup>
            <!-- Logout -->
            <actionGroup ref="AdminLogoutActionGroup" stepKey="logout"/>
        </after>
        <!-- Step-4: Open Conf 1 and add configurations with my_size attribute -->
        <actionGroup ref="AdminProductPageOpenByIdActionGroup" stepKey="openConfigProduct1">
            <argument name="productId" value="$createConfigProduct1.id$"/>
        </actionGroup>
        <waitForPageLoad stepKey="waitForConfigProduct1PageLoad"/>
        <!-- Create configurations for Conf 1 with my_size attribute -->
        <actionGroup ref="GenerateConfigurationsByAttributeCodeActionGroup" stepKey="createConfigurationsForConf1">
            <argument name="attributeCode" value="{{DropdownSizeAttributeData.attribute_code}}"/>
        </actionGroup>
        <!-- Set custom prices for Small and Large variants -->
        <actionGroup ref="ChangeConfigurableProductChildProductPriceActionGroup" stepKey="changePriceForSmall">
            <argument name="productAttributes" value="{{SizeAttributeDisplay.small}}"/>
            <argument name="productPrice" value="110"/>
        </actionGroup>
        <actionGroup ref="ChangeConfigurableProductChildProductPriceActionGroup" stepKey="changePriceForLarge">
            <argument name="productAttributes" value="{{SizeAttributeDisplay.large}}"/>
            <argument name="productPrice" value="130"/>
        </actionGroup>
        <actionGroup ref="SaveConfigurableProductAddToCurrentAttributeSetActionGroup" stepKey="saveConfigProduct1"/>
        <!-- Step-5: Open Conf 2 and add configurations with both attributes (color_swatch and my_size) -->
        <actionGroup ref="AdminProductPageOpenByIdActionGroup" stepKey="openConfigProduct2">
            <argument name="productId" value="$createConfigProduct2.id$"/>
        </actionGroup>
        <waitForPageLoad stepKey="waitForConfigProduct2PageLoad"/>
        <!-- Create configurations for Conf 2 with both attributes -->
        <waitForElementClickable selector="{{AdminProductFormConfigurationsSection.createConfigurations}}" stepKey="waitForCreateConfigurationsClickableForConf2"/>
        <click selector="{{AdminProductFormConfigurationsSection.createConfigurations}}" stepKey="clickCreateConfigurationsForConf2"/>
        <waitForElementVisible selector="{{AdminCreateProductConfigurationsPanel.createNewAttribute}}" stepKey="waitForConfigurationModalOpen"/>
        <!-- Select both my_size and color_swatch attributes -->
        <click selector="{{AdminCreateProductConfigurationsPanel.attributeCheckbox(DropdownSizeAttributeData.attribute_code)}}" stepKey="selectSizeAttribute"/>
        <click selector="{{AdminCreateProductConfigurationsPanel.attributeCheckbox(TextSwatchColorAttributeData.attribute_code)}}" stepKey="selectColorAttribute"/>
        <click selector="{{AdminCreateProductConfigurationsPanel.next}}" stepKey="clickOnNextButton1ForConf2"/>
        <!-- Select only Small and Large for my_size, and Black and White for color_swatch -->
        <waitForElementVisible selector="{{AdminCreateProductConfigurationsPanel.attributeCheckboxByName(AttributeOptionSmall.value)}}" stepKey="waitForOptionsForConf2"/>
        <click selector="{{AdminCreateProductConfigurationsPanel.attributeCheckboxByName(AttributeOptionSmall.value)}}" stepKey="selectSmallOptionForConf2"/>
        <click selector="{{AdminCreateProductConfigurationsPanel.attributeCheckboxByName(AttributeOptionLarge.value)}}" stepKey="selectLargeOptionForConf2"/>
        <click selector="{{AdminCreateProductConfigurationsPanel.attributeCheckboxByName(AttributeOptionBlack.value)}}" stepKey="selectBlackOptionForConf2"/>
        <click selector="{{AdminCreateProductConfigurationsPanel.attributeCheckboxByName(AttributeOptionWhite.value)}}" stepKey="selectWhiteOptionForConf2"/>
        <click selector="{{AdminCreateProductConfigurationsPanel.next}}" stepKey="clickOnNextButton2ForConf2"/>
        <!-- Apply single quantity to all SKUs -->
        <waitForElementVisible selector="{{AdminCreateProductConfigurationsPanel.applySingleQuantityToEachSkus}}" stepKey="waitForQuantitySection"/>
        <click selector="{{AdminCreateProductConfigurationsPanel.applySingleQuantityToEachSkus}}" stepKey="clickSingleQuantity"/>
        <fillField selector="{{AdminCreateProductConfigurationsPanel.quantity}}" userInput="100" stepKey="fillQuantity"/>
        <click selector="{{AdminCreateProductConfigurationsPanel.next}}" stepKey="clickOnNextButton3ForConf2"/>
        <!-- Generate products -->
        <click selector="{{AdminCreateProductConfigurationsPanel.next}}" stepKey="clickOnNextButton4ForConf2"/>
        <waitForElementVisible selector="{{AdminProductFormActionSection.saveButton}}" stepKey="waitForSaveButtonForConf2"/>
        <!-- Set custom prices for all variants -->
        <actionGroup ref="ChangeConfigurableProductChildProductPriceActionGroup" stepKey="changePriceForBlackSmall">
            <argument name="productAttributes" value="{{SizeAttributeDisplay.small_black}}"/>
            <argument name="productPrice" value="210"/>
        </actionGroup>
        <actionGroup ref="ChangeConfigurableProductChildProductPriceActionGroup" stepKey="changePriceForBlackLarge">
            <argument name="productAttributes" value="{{SizeAttributeDisplay.large_black}}"/>
            <argument name="productPrice" value="230"/>
        </actionGroup>
        <actionGroup ref="ChangeConfigurableProductChildProductPriceActionGroup" stepKey="changePriceForWhiteSmall">
            <argument name="productAttributes" value="{{SizeAttributeDisplay.small_white}}"/>
            <argument name="productPrice" value="250"/>
        </actionGroup>
        <actionGroup ref="ChangeConfigurableProductChildProductPriceActionGroup" stepKey="changePriceForWhiteLarge">
            <argument name="productAttributes" value="{{SizeAttributeDisplay.large_white}}"/>
            <argument name="productPrice" value="270"/>
        </actionGroup>
        <actionGroup ref="SaveConfigurableProductAddToCurrentAttributeSetActionGroup" stepKey="saveConfigProduct2"/>
        <!-- Step-6: Create Catalog Products List widget -->
        <actionGroup ref="AdminConfigureWidgetWithSpecificProductsActionGroup" stepKey="configureWidget">
            <argument name="productId" value="$createConfigProduct1.id$"/>
        </actionGroup>
        <actionGroup ref="AdminSaveAndContinueWidgetActionGroup" stepKey="saveWidget"/>
        <!-- Step-7: Open Conf 1 product page on storefront and validate price changes -->
        <actionGroup ref="StorefrontOpenProductPageActionGroup" stepKey="openConf1ProductPage">
            <argument name="productUrl" value="conf-1"/>
        </actionGroup>
        <waitForElementVisible selector="{{StorefrontProductInfoMainSection.productName}}" stepKey="waitForProductName"/>
        <waitForText selector="{{StorefrontProductInfoMainSection.productName}}" userInput="Conf 1" stepKey="verifyProductName"/>
        <!-- Verify default price before selection -->
        <waitForElementVisible selector="{{StorefrontProductInfoMainSection.productPrice}}" stepKey="waitForDefaultPrice"/>
        <!-- Select Small option and verify price -->
        <waitForElementVisible selector="{{StorefrontProductInfoMainSection.productAttributeOptionsSelectButton}}" stepKey="waitForAttributeDropdown"/>
        <selectOption selector="{{StorefrontProductInfoMainSection.productAttributeOptionsSelectButton}}" userInput="{{AttributeOptionSmall.value}}" stepKey="selectSmallOption"/>
        <waitForElementVisible selector="{{StorefrontProductInfoMainSection.productPrice}}" stepKey="waitForPriceAfterSmallSelection"/>
        <waitForText selector="{{StorefrontProductInfoMainSection.productPrice}}" userInput="$110.00" stepKey="verifySmallPrice"/>
        <!-- Select Large option and verify price changes -->
        <selectOption selector="{{StorefrontProductInfoMainSection.productAttributeOptionsSelectButton}}" userInput="{{AttributeOptionLarge.value}}" stepKey="selectLargeOption"/>
        <waitForElementVisible selector="{{StorefrontProductInfoMainSection.productPrice}}" stepKey="waitForPriceAfterLargeSelection"/>
        <waitForText selector="{{StorefrontProductInfoMainSection.productPrice}}" userInput="$130.00" stepKey="verifyLargePrice"/>
        <!-- Select Small again and verify price changes back -->
        <selectOption selector="{{StorefrontProductInfoMainSection.productAttributeOptionsSelectButton}}" userInput="{{AttributeOptionSmall.value}}" stepKey="selectSmallOptionAgain"/>
        <waitForElementVisible selector="{{StorefrontProductInfoMainSection.productPrice}}" stepKey="waitForPriceAfterSmallSelectionAgain"/>
        <waitForText selector="{{StorefrontProductInfoMainSection.productPrice}}" userInput="$110.00" stepKey="verifySmallPriceAgain"/>
    </test>
</tests>
