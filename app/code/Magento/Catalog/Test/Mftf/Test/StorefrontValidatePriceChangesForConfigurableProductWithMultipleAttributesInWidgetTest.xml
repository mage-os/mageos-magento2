<?xml version="1.0" encoding="UTF-8"?>
<!--
/**
 * Copyright 2025 Adobe
 * All Rights Reserved.
 */
-->
<tests xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:noNamespaceSchemaLocation="urn:magento:mftf:Test/etc/testSchema.xsd">
    <test name="StorefrontValidatePriceChangesForConfigurableProductWithMultipleAttributesInWidgetTest">
        <annotations>
            <features value="Catalog"/>
            <stories value="Product Price Display"/>
            <title value="Validate price changes for configurable product with dropdown and text swatch attributes on storefront"/>
            <description value="Create dropdown and text swatch attributes, create two configurable products with different attribute combinations, and validate price changes on storefront product page"/>
            <testCaseId value="AC-8423"/>
            <severity value="MAJOR"/>
            <group value="Catalog"/>
        </annotations>
        <before>
            <!-- Step-1: Login to admin -->
            <actionGroup ref="AdminLoginActionGroup" stepKey="loginAsAdmin"/>
            <!-- Create category for products -->
            <createData entity="_defaultCategory" stepKey="createCategory"/>
            <!-- Step-2: Create a dropdown product attribute with two options -->
            <createData entity="DropdownSizeAttributeData" stepKey="createDropdownAttribute"/>
            <createData entity="DropdownSizeOptionSmall" stepKey="createAttributeOptionSmall">
                <requiredEntity createDataKey="createDropdownAttribute"/>
            </createData>
            <createData entity="DropdownSizeOptionLarge" stepKey="createAttributeOptionLarge">
                <requiredEntity createDataKey="createDropdownAttribute"/>
            </createData>
            <!-- Step-3: Create a text swatch product attribute with two options -->
            <createData entity="TextSwatchColorAttributeData" stepKey="createTextSwatchAttribute"/>
            <createData entity="TextSwatchOptionBlack" stepKey="createAttributeOptionBlack">
                <requiredEntity createDataKey="createTextSwatchAttribute"/>
            </createData>
            <createData entity="TextSwatchOptionWhite" stepKey="createAttributeOptionWhite">
                <requiredEntity createDataKey="createTextSwatchAttribute"/>
            </createData>
            <!-- Create configurable products -->
            <createData entity="ApiConfigurableProduct" stepKey="createConfigProduct1">
                <requiredEntity createDataKey="createCategory"/>
                <field key="name">{{ConfigurableProduct1.name}}</field>
                <field key="sku">{{ConfigurableProduct1.sku}}</field>
                <field key="price">{{ConfigurableProduct1.price}}</field>
            </createData>
            <createData entity="ApiConfigurableProduct" stepKey="createConfigProduct2">
                <requiredEntity createDataKey="createCategory"/>
                <field key="name">{{ConfigurableProduct2.name}}</field>
                <field key="sku">{{ConfigurableProduct2.sku}}</field>
                <field key="price">{{ConfigurableProduct2.price}}</field>
            </createData>
        </before>
        <after>
            <!-- Delete category -->
            <deleteData createDataKey="createCategory" stepKey="deleteCategory"/>
            <!-- Delete configurable product & its variants via API using ProductApiHelper -->
            <helper class="Magento\Catalog\Test\Mftf\Helper\ProductApiHelper" method="deleteAllProductsApi" stepKey="deleteAllProductsViaApi"/>
            <!-- Delete widget -->
            <actionGroup ref="AdminDeleteWidgetActionGroup" stepKey="deleteWidget">
                <argument name="widget" value="SampleCatalogProductsListWidget"/>
            </actionGroup>
            <!-- Delete dropdown attribute -->
            <deleteData createDataKey="createDropdownAttribute" stepKey="deleteDropdownAttribute"/>
            <!-- Delete text swatch attribute -->
            <deleteData createDataKey="createTextSwatchAttribute" stepKey="deleteSwatchAttribute"/>
            <!-- Logout -->
            <actionGroup ref="AdminLogoutActionGroup" stepKey="logout"/>
        </after>
        <!-- Step-4: Open Conf 1 and add configurations with my_size attribute -->
        <actionGroup ref="AdminProductPageOpenByIdActionGroup" stepKey="openConfigProduct1">
            <argument name="productId" value="$createConfigProduct1.id$"/>
        </actionGroup>
        <waitForPageLoad stepKey="waitForConfigProduct1PageLoad"/>
        <!-- Create configurations for Conf 1 with my_size attribute -->
        <actionGroup ref="GenerateConfigurationsByAttributeCodeActionGroup" stepKey="createConfigurationsForConf1">
            <argument name="attributeCode" value="$createDropdownAttribute.attribute_code$"/>
        </actionGroup>
        <!-- Set custom prices for Small and Large variants -->
        <actionGroup ref="ChangeConfigurableProductChildProductPriceActionGroup" stepKey="changePriceForSmall">
            <argument name="productAttributes" value="{{SizeAttributeDisplay.small}}"/>
            <argument name="productPrice" value="110"/>
        </actionGroup>
        <actionGroup ref="ChangeConfigurableProductChildProductPriceActionGroup" stepKey="changePriceForLarge">
            <argument name="productAttributes" value="{{SizeAttributeDisplay.large}}"/>
            <argument name="productPrice" value="130"/>
        </actionGroup>
        <actionGroup ref="SaveConfigurableProductAddToCurrentAttributeSetActionGroup" stepKey="saveConfigProduct1"/>
        <!-- Step-5: Open Conf 2 and add configurations with both attributes (color_swatch and my_size) -->
        <actionGroup ref="AdminProductPageOpenByIdActionGroup" stepKey="openConfigProduct2">
            <argument name="productId" value="$createConfigProduct2.id$"/>
        </actionGroup>
        <waitForPageLoad stepKey="waitForConfigProduct2PageLoad"/>
        <!-- Create configurations for Conf 2 with both attributes -->
        <waitForElementClickable selector="{{AdminProductFormConfigurationsSection.createConfigurations}}" stepKey="waitForCreateConfigurationsClickableForConf2"/>
        <click selector="{{AdminProductFormConfigurationsSection.createConfigurations}}" stepKey="clickCreateConfigurationsForConf2"/>
        <waitForElementVisible selector="{{AdminCreateProductConfigurationsPanel.createNewAttribute}}" stepKey="waitForConfigurationModalOpen"/>
        <!-- Select both my_size and color_swatch attributes -->
        <click selector="{{AdminCreateProductConfigurationsPanel.attributeCheckbox($createDropdownAttribute.attribute_code$)}}" stepKey="selectSizeAttribute"/>
        <click selector="{{AdminCreateProductConfigurationsPanel.attributeCheckbox($createTextSwatchAttribute.attribute_code$)}}" stepKey="selectColorAttribute"/>
        <click selector="{{AdminCreateProductConfigurationsPanel.next}}" stepKey="clickOnNextButton1ForConf2"/>
        <!-- Select only Small and Large for my_size, and Black and White for color_swatch -->
        <waitForElementVisible selector="{{AdminCreateProductConfigurationsPanel.attributeCheckboxByName(AttributeOptionSmall.value)}}" stepKey="waitForOptionsForConf2"/>
        <click selector="{{AdminCreateProductConfigurationsPanel.attributeCheckboxByName(AttributeOptionSmall.value)}}" stepKey="selectSmallOptionForConf2"/>
        <click selector="{{AdminCreateProductConfigurationsPanel.attributeCheckboxByName(AttributeOptionLarge.value)}}" stepKey="selectLargeOptionForConf2"/>
        <click selector="{{AdminCreateProductConfigurationsPanel.attributeCheckboxByName(AttributeOptionBlack.value)}}" stepKey="selectBlackOptionForConf2"/>
        <click selector="{{AdminCreateProductConfigurationsPanel.attributeCheckboxByName(AttributeOptionWhite.value)}}" stepKey="selectWhiteOptionForConf2"/>
        <click selector="{{AdminCreateProductConfigurationsPanel.next}}" stepKey="clickOnNextButton2ForConf2"/>
        <!-- Apply single quantity to all SKUs -->
        <waitForElementVisible selector="{{AdminCreateProductConfigurationsPanel.applySingleQuantityToEachSkus}}" stepKey="waitForQuantitySection"/>
        <click selector="{{AdminCreateProductConfigurationsPanel.applySingleQuantityToEachSkus}}" stepKey="clickSingleQuantity"/>
        <fillField selector="{{AdminCreateProductConfigurationsPanel.quantity}}" userInput="100" stepKey="fillQuantity"/>
        <click selector="{{AdminCreateProductConfigurationsPanel.next}}" stepKey="clickOnNextButton3ForConf2"/>
        <!-- Generate products -->
        <click selector="{{AdminCreateProductConfigurationsPanel.next}}" stepKey="clickOnNextButton4ForConf2"/>
        <waitForElementVisible selector="{{AdminProductFormActionSection.saveButton}}" stepKey="waitForSaveButtonForConf2"/>
        <!-- Set custom prices for all variants -->
        <actionGroup ref="ChangeConfigurableProductChildProductPriceActionGroup" stepKey="changePriceForBlackSmall">
            <argument name="productAttributes" value="{{SizeAttributeDisplay.small_black}}"/>
            <argument name="productPrice" value="210"/>
        </actionGroup>
        <actionGroup ref="ChangeConfigurableProductChildProductPriceActionGroup" stepKey="changePriceForBlackLarge">
            <argument name="productAttributes" value="{{SizeAttributeDisplay.large_black}}"/>
            <argument name="productPrice" value="230"/>
        </actionGroup>
        <actionGroup ref="ChangeConfigurableProductChildProductPriceActionGroup" stepKey="changePriceForWhiteSmall">
            <argument name="productAttributes" value="{{SizeAttributeDisplay.small_white}}"/>
            <argument name="productPrice" value="250"/>
        </actionGroup>
        <actionGroup ref="ChangeConfigurableProductChildProductPriceActionGroup" stepKey="changePriceForWhiteLarge">
            <argument name="productAttributes" value="{{SizeAttributeDisplay.large_white}}"/>
            <argument name="productPrice" value="270"/>
        </actionGroup>
        <actionGroup ref="SaveConfigurableProductAddToCurrentAttributeSetActionGroup" stepKey="saveConfigProduct2"/>
        <!-- Step-6: Create Catalog Products List widget -->
        <actionGroup ref="AdminConfigureWidgetWithSpecificProductsActionGroup" stepKey="configureWidget">
            <argument name="productId" value="$createConfigProduct1.id$"/>
        </actionGroup>
        <actionGroup ref="AdminSaveAndContinueWidgetActionGroup" stepKey="saveWidget"/>
        <!-- Step-7: Open Conf 1 product page on storefront and validate price changes -->
        <actionGroup ref="StorefrontOpenProductPageActionGroup" stepKey="openConf1ProductPage">
            <argument name="productUrl" value="{{ConfigurableProduct1.sku}}"/>
        </actionGroup>
        <waitForElementVisible selector="{{StorefrontProductInfoMainSection.productName}}" stepKey="waitForProductName"/>
        <waitForText selector="{{StorefrontProductInfoMainSection.productName}}" userInput="{{ConfigurableProduct1.name}}" stepKey="verifyProductName"/>
        <!-- Verify default price before selection -->
        <waitForElementVisible selector="{{StorefrontProductInfoMainSection.productPrice}}" stepKey="waitForDefaultPrice"/>
        <!-- Select Small option and verify price -->
        <waitForElementVisible selector="{{StorefrontProductInfoMainSection.productAttributeOptionsSelectButton}}" stepKey="waitForAttributeDropdown"/>
        <selectOption selector="{{StorefrontProductInfoMainSection.productAttributeOptionsSelectButton}}" userInput="{{AttributeOptionSmall.value}}" stepKey="selectSmallOption"/>
        <waitForElementVisible selector="{{StorefrontProductInfoMainSection.productPrice}}" stepKey="waitForPriceAfterSmallSelection"/>
        <waitForText selector="{{StorefrontProductInfoMainSection.productPrice}}" userInput="$110.00" stepKey="verifySmallPrice"/>
        <!-- Select Large option and verify price changes -->
        <selectOption selector="{{StorefrontProductInfoMainSection.productAttributeOptionsSelectButton}}" userInput="{{AttributeOptionLarge.value}}" stepKey="selectLargeOption"/>
        <waitForElementVisible selector="{{StorefrontProductInfoMainSection.productPrice}}" stepKey="waitForPriceAfterLargeSelection"/>
        <waitForText selector="{{StorefrontProductInfoMainSection.productPrice}}" userInput="$130.00" stepKey="verifyLargePrice"/>
        <!-- Select Small again and verify price changes back -->
        <selectOption selector="{{StorefrontProductInfoMainSection.productAttributeOptionsSelectButton}}" userInput="{{AttributeOptionSmall.value}}" stepKey="selectSmallOptionAgain"/>
        <waitForElementVisible selector="{{StorefrontProductInfoMainSection.productPrice}}" stepKey="waitForPriceAfterSmallSelectionAgain"/>
        <waitForText selector="{{StorefrontProductInfoMainSection.productPrice}}" userInput="$110.00" stepKey="verifySmallPriceAgain"/>
    </test>
</tests>
