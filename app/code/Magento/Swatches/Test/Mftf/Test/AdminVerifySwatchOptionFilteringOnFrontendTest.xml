<?xml version="1.0" encoding="UTF-8"?>
<!--
 /**
  * Copyright 2025 Adobe
  * All Rights Reserved.
  */
-->

<tests xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:noNamespaceSchemaLocation="urn:magento:mftf:Test/etc/testSchema.xsd">
    <test name="AdminVerifySwatchOptionFilteringOnFrontendTest">
        <annotations>
            <features value="Swatches"/>
            <stories value="Configurable Product Swatch Filtering"/>
            <title value="Verify not existed simple products"/>
            <description value="Verify that options which do not exist are not shown in attribute list per selection"/>
            <severity value="MAJOR"/>
            <testCaseId value="AC-4616"/>
            <group value="swatches"/>
            <group value="catalog"/>
        </annotations>
        <before>
            <actionGroup ref="AdminLoginActionGroup" stepKey="loginAsAdmin"/>
            <!-- Create category -->
            <createData entity="_defaultCategory" stepKey="createCategory"/>
        </before>
        <after>
            <!-- Delete category -->
            <deleteData createDataKey="createCategory" stepKey="deleteCategory"/>
            <!-- Delete configurable product & its variants via API using ProductApiHelper -->
            <helper class="Magento\Catalog\Test\Mftf\Helper\ProductApiHelper" method="deleteAllProductsApi" stepKey="deleteAllProductsViaApi"/>
            <!-- Delete product attributes -->
            <actionGroup ref="DeleteProductAttributeByCodeActionGroup" stepKey="deleteVisualAttribute">
                <argument name="attribute_code" value="visual_swatch_attr"/>
            </actionGroup>
            <actionGroup ref="DeleteProductAttributeByCodeActionGroup" stepKey="deleteText1Attribute">
                <argument name="attribute_code" value="text_swatch_attr1"/>
            </actionGroup>
            <actionGroup ref="DeleteProductAttributeByCodeActionGroup" stepKey="deleteText2Attribute">
                <argument name="attribute_code" value="text_swatch_attr2"/>
            </actionGroup>
            <actionGroup ref="CliIndexerReindexActionGroup" stepKey="reindexAfterCleanup">
                <argument name="indices" value=""/>
            </actionGroup>
            <actionGroup ref="AdminLogoutActionGroup" stepKey="adminLogout"/>
        </after>
        <!-- Step 1a: Create Visual Swatch Attribute with options A, B, C -->
        <amOnPage url="{{ProductAttributePage.url}}" stepKey="goToNewAttributePage"/>
        <waitForPageLoad stepKey="waitForAttributePage"/>
        <fillField selector="{{AttributePropertiesSection.DefaultLabel}}" userInput="VisualSwatchAttr" stepKey="fillAttributeLabel"/>
        <selectOption selector="{{AttributePropertiesSection.InputType}}" userInput="swatch_visual" stepKey="selectVisualSwatchType"/>
        <!-- Add 3 visual swatch options: A, B, C -->
        <click selector="{{AdminManageSwatchSection.addSwatch}}" stepKey="clickAddSwatch1"/>
        <actionGroup ref="OpenSwatchMenuByIndexActionGroup" stepKey="openSwatch1">
            <argument name="index" value="0"/>
        </actionGroup>
        <click selector="{{AdminManageSwatchSection.nthChooseColor('1')}}" stepKey="clickChooseColor1"/>
        <actionGroup ref="SetColorPickerByHexActionGroup" stepKey="setColorHex1">
            <argument name="nthColorPicker" value="1"/>
            <argument name="hexColor" value="e74c3c"/>
        </actionGroup>
        <fillField selector="{{AdminManageSwatchSection.adminInputByIndex('0')}}" userInput="A" stepKey="fillSwatchAdminOption1"/>
        <click selector="{{AdminManageSwatchSection.addSwatch}}" stepKey="clickAddSwatch2"/>
        <actionGroup ref="OpenSwatchMenuByIndexActionGroup" stepKey="openSwatch2">
            <argument name="index" value="1"/>
        </actionGroup>
        <click selector="{{AdminManageSwatchSection.nthChooseColor('2')}}" stepKey="clickChooseColor2"/>
        <actionGroup ref="SetColorPickerByHexActionGroup" stepKey="setColorHex2">
            <argument name="nthColorPicker" value="2"/>
            <argument name="hexColor" value="2ecc71"/>
        </actionGroup>
        <fillField selector="{{AdminManageSwatchSection.adminInputByIndex('1')}}" userInput="B" stepKey="fillSwatchAdminOption2"/>
        <click selector="{{AdminManageSwatchSection.addSwatch}}" stepKey="clickAddSwatch3"/>
        <actionGroup ref="OpenSwatchMenuByIndexActionGroup" stepKey="openSwatch3">
            <argument name="index" value="2"/>
        </actionGroup>
        <click selector="{{AdminManageSwatchSection.nthChooseColor('3')}}" stepKey="clickChooseColor3"/>
        <actionGroup ref="SetColorPickerByHexActionGroup" stepKey="setColorHex3">
            <argument name="nthColorPicker" value="3"/>
            <argument name="hexColor" value="3498db"/>
        </actionGroup>
        <fillField selector="{{AdminManageSwatchSection.adminInputByIndex('2')}}" userInput="C" stepKey="fillSwatchAdminOption3"/>
        <click selector="{{AttributePropertiesSection.AdvancedProperties}}" stepKey="expandAdvancedProperties"/>
        <selectOption selector="{{AttributePropertiesSection.Scope}}" userInput="1" stepKey="selectGlobalScope"/>
        <fillField selector="{{AdvancedAttributePropertiesSection.AttributeCode}}" userInput="visual_swatch_attr" stepKey="fillAttributeCode"/>
        <scrollToTopOfPage stepKey="scrollToTopForStorefrontTab"/>
        <click selector="{{StorefrontPropertiesSection.StoreFrontPropertiesTab}}" stepKey="clickStorefrontPropertiesTab"/>
        <waitForElementVisible selector="{{AdvancedAttributePropertiesSection.UseInProductListing}}" stepKey="waitForStorefrontTabSwitch"/>
        <selectOption selector="{{AdvancedAttributePropertiesSection.UseInProductListing}}" userInput="Yes" stepKey="setUseInProductListing"/>
        <click selector="{{AttributePropertiesSection.SaveAndEdit}}" stepKey="saveVisualAttribute"/>
        <waitForElementVisible selector="{{AdminProductMessagesSection.successMessage}}" stepKey="waitForVisualAttributeSaved"/>
        <!-- Step 1b: Create Text Swatch Attribute 1 with options 1, 2, 3 -->
        <actionGroup ref="AddTextSwatchToProductActionGroup" stepKey="addTextSwatchAttribute1">
            <argument name="attributeName" value="TextSwatchAttr1"/>
            <argument name="attributeCode" value="text_swatch_attr1"/>
            <argument name="option1" value="1"/>
            <argument name="option2" value="2"/>
            <argument name="option3" value="3"/>
            <argument name="usedInProductListing" value="Yes"/>
        </actionGroup>
        <!-- Step 1c: Create Text Swatch Attribute 2 with options X, Y, Z -->
        <actionGroup ref="AddTextSwatchToProductActionGroup" stepKey="addTextSwatchAttribute2">
            <argument name="attributeName" value="TextSwatchAttr2"/>
            <argument name="attributeCode" value="text_swatch_attr2"/>
            <argument name="option1" value="X"/>
            <argument name="option2" value="Y"/>
            <argument name="option3" value="Z"/>
            <argument name="usedInProductListing" value="Yes"/>
        </actionGroup>
        <!-- Step 2a: Create Products on base of created attributes -->
        <comment userInput="Creating configurable product with all three swatch attributes" stepKey="productCreationNote"/>
        <actionGroup ref="AdminOpenProductIndexPageActionGroup" stepKey="navigateToProductIndex"/>
        <actionGroup ref="GoToCreateProductPageActionGroup" stepKey="goToCreateProduct">
            <argument name="product" value="BaseConfigurableProduct"/>
        </actionGroup>
        <fillField selector="{{AdminProductFormSection.productName}}" userInput="TestConfigurableProduct" stepKey="fillProductName"/>
        <fillField selector="{{AdminProductFormSection.productSku}}" userInput="test-config" stepKey="fillProductSku"/>
        <fillField selector="{{AdminProductFormSection.productPrice}}" userInput="100" stepKey="fillProductPrice"/>
        <searchAndMultiSelectOption selector="{{AdminProductFormSection.categoriesDropdown}}" parameterArray="[$$createCategory.name$$]" stepKey="selectCategory"/>
        <!-- Create configurations with 3 attributes -->
        <click selector="{{AdminProductFormConfigurationsSection.createConfigurations}}" stepKey="clickCreateConfigurations"/>
        <waitForPageLoad stepKey="waitForConfigurationPanel"/>
        <!-- Select all 3 attributes -->
        <click selector="{{AdminCreateProductConfigurationsPanel.attributeCheckbox('visual_swatch_attr')}}" stepKey="selectVisualAttribute"/>
        <click selector="{{AdminCreateProductConfigurationsPanel.attributeCheckbox('text_swatch_attr1')}}" stepKey="selectTextAttribute1"/>
        <click selector="{{AdminCreateProductConfigurationsPanel.attributeCheckbox('text_swatch_attr2')}}" stepKey="selectTextAttribute2"/>
        <click selector="{{AdminCreateProductConfigurationsPanel.next}}" stepKey="clickNextStep1"/>
        <!-- Select all options for all 3 attributes - this generates all 27 variations -->
        <click selector="{{AdminCreateProductConfigurationsPanel.selectAllByAttribute('VisualSwatchAttr')}}" stepKey="selectAllVisualOptions"/>
        <click selector="{{AdminCreateProductConfigurationsPanel.selectAllByAttribute('TextSwatchAttr1')}}" stepKey="selectAllText1Options"/>
        <click selector="{{AdminCreateProductConfigurationsPanel.selectAllByAttribute('TextSwatchAttr2')}}" stepKey="selectAllText2Options"/>
        <click selector="{{AdminCreateProductConfigurationsPanel.next}}" stepKey="clickNextStep2"/>
        <!-- Apply pricing -->
        <click selector="{{AdminCreateProductConfigurationsPanel.applySinglePriceToAllSkus}}" stepKey="clickApplySinglePrice"/>
        <fillField selector="{{AdminCreateProductConfigurationsPanel.singlePrice}}" userInput="10" stepKey="enterPrice"/>
        <click selector="{{AdminCreateProductConfigurationsPanel.applySingleQuantityToEachSkus}}" stepKey="clickApplySingleQuantity"/>
        <fillField selector="{{AdminCreateProductConfigurationsPanel.quantity}}" userInput="100" stepKey="enterQuantity"/>
        <click selector="{{AdminCreateProductConfigurationsPanel.next}}" stepKey="clickNextStep3"/>
        <!-- Generate all variations -->
        <click selector="{{AdminCreateProductConfigurationsPanel.next}}" stepKey="generateVariations"/>
        <waitForPageLoad stepKey="waitForVariationsGenerated"/>
        <!-- Save configurable product -->
        <click selector="{{AdminProductFormActionSection.saveButton}}" stepKey="saveConfigProduct"/>
        <conditionalClick selector="{{AdminChooseAffectedAttributeSetPopup.confirm}}" dependentSelector="{{AdminChooseAffectedAttributeSetPopup.confirm}}" visible="true" stepKey="confirmAttributeSetPopup"/>
        <waitForElementVisible selector="{{AdminProductMessagesSection.successMessage}}" stepKey="waitForProductSaveSuccess"/>
        <!-- Step 2b: Delete the 3 products that should NOT exist: A-2-Z, B-2-X, A-3-X -->
        <comment userInput="Deleting non-existent product combinations: A-2-Z, B-2-X, A-3-X" stepKey="deletionNote"/>
        <!-- Delete A-2-Z -->
        <actionGroup ref="DeleteProductBySkuActionGroup" stepKey="deleteProductA2Z">
            <argument name="sku" value="test-config-A-2-Z"/>
        </actionGroup>
        <!-- Delete B-2-X -->
        <actionGroup ref="DeleteProductBySkuActionGroup" stepKey="deleteProductB2X">
            <argument name="sku" value="test-config-B-2-X"/>
        </actionGroup>
        <!-- Delete A-3-X -->
        <actionGroup ref="DeleteProductBySkuActionGroup" stepKey="deleteProductA3X">
            <argument name="sku" value="test-config-A-3-X"/>
        </actionGroup>
        <!-- Reindex catalog indices and flush cache -->
        <actionGroup ref="CliIndexerReindexActionGroup" stepKey="reindexCatalogIndices">
            <argument name="indices" value="catalog_product_attribute catalog_product_price cataloginventory_stock"/>
        </actionGroup>
        <actionGroup ref="CliCacheFlushActionGroup" stepKey="flushCacheAfterProductSetup">
            <argument name="tags" value=""/>
        </actionGroup>
        <!-- Step 3: Open frontend catalog page with the product -->
        <amOnPage url="{{StorefrontCategoryPage.url($$createCategory.custom_attributes[url_key]$$)}}" stepKey="navigateToCategoryPage"/>
        <waitForPageLoad stepKey="waitForCategoryPage"/>
        <seeElement selector="{{StorefrontCategoryMainSection.productLink}}" stepKey="seeProductInCategory"/>
        <!-- Step 4: Click A swatch on category page -->
        <actionGroup ref="StorefrontSelectSwatchOptionOnCategoryPageWithHoverActionGroup" stepKey="selectSwatchA">
            <argument name="optionLabel" value="A"/>
        </actionGroup>
        <!-- Step 5: Click 2 swatch on category page -->
        <actionGroup ref="StorefrontSelectSwatchOptionOnCategoryPageWithHoverActionGroup" stepKey="selectSwatch2">
            <argument name="optionLabel" value="2"/>
        </actionGroup>
        <!-- Step 5 Expected Result: Swatch Z is crossed on category page -->
        <grabAttributeFrom selector="{{StorefrontCategoryPageProductInfoSection.swatchOptionByLabel('Z')}}" userInput="disabled" stepKey="grabZDisabled_A2"/>
        <assertEquals stepKey="assertZDisabled_A2">
            <expectedResult type="string">true</expectedResult>
            <actualResult type="string">{$grabZDisabled_A2}</actualResult>
        </assertEquals>
        <!-- Step 6: Click X swatch on category page -->
        <actionGroup ref="StorefrontSelectSwatchOptionOnCategoryPageWithHoverActionGroup" stepKey="selectSwatchX">
            <argument name="optionLabel" value="X"/>
        </actionGroup>
        <!-- Step 6 Expected Result: Swatches B, 3, Z are crossed on category page -->
        <grabAttributeFrom selector="{{StorefrontCategoryPageProductInfoSection.swatchOptionByLabel('B')}}" userInput="disabled" stepKey="grabBDisabled_A2X"/>
        <assertEquals stepKey="assertBDisabled_A2X">
            <expectedResult type="string">true</expectedResult>
            <actualResult type="string">{$grabBDisabled_A2X}</actualResult>
        </assertEquals>
        <grabAttributeFrom selector="{{StorefrontCategoryPageProductInfoSection.swatchOptionByLabel('3')}}" userInput="disabled" stepKey="grab3Disabled_A2X"/>
        <assertEquals stepKey="assert3Disabled_A2X">
            <expectedResult type="string">true</expectedResult>
            <actualResult type="string">{$grab3Disabled_A2X}</actualResult>
        </assertEquals>
        <grabAttributeFrom selector="{{StorefrontCategoryPageProductInfoSection.swatchOptionByLabel('Z')}}" userInput="disabled" stepKey="grabZDisabled_A2X"/>
        <assertEquals stepKey="assertZDisabled_A2X">
            <expectedResult type="string">true</expectedResult>
            <actualResult type="string">{$grabZDisabled_A2X}</actualResult>
        </assertEquals>
        <!-- Step 7: Click on the 1 on category page -->
        <actionGroup ref="StorefrontSelectSwatchOptionOnCategoryPageWithHoverActionGroup" stepKey="selectSwatch1">
            <argument name="optionLabel" value="1"/>
        </actionGroup>
        <!-- Step 7 Expected Result: Swatch B is crossed on category page -->
        <grabAttributeFrom selector="{{StorefrontCategoryPageProductInfoSection.swatchOptionByLabel('B')}}" userInput="disabled" stepKey="grabBDisabled_A1X"/>
        <assertEquals stepKey="assertBDisabled_A1X">
            <expectedResult type="string">true</expectedResult>
            <actualResult type="string">{$grabBDisabled_A1X}</actualResult>
        </assertEquals>
        <!-- Step 8: Open the product page and repeat steps 4-7 -->
        <click selector="{{StorefrontCategoryMainSection.productLink}}" stepKey="openProductPage"/>
        <waitForPageLoad stepKey="waitForPDP"/>
        <!-- Repeat Step 4: Click A swatch -->
        <actionGroup ref="StorefrontSelectSwatchOptionOnProductPageWithScrollAndHoverActionGroup" stepKey="selectSwatchA_PDP">
            <argument name="optionName" value="A"/>
        </actionGroup>
        <!-- Repeat Step 5: Click 2 swatch -->
        <actionGroup ref="StorefrontSelectSwatchOptionOnProductPageWithScrollAndHoverActionGroup" stepKey="selectSwatch2_PDP">
            <argument name="optionName" value="2"/>
        </actionGroup>
        <!-- Step 5 Expected Result on PDP: Swatch Z is crossed -->
        <grabAttributeFrom selector="{{StorefrontProductInfoMainSection.swatchOptionByLabel('Z')}}" userInput="disabled" stepKey="grabZDisabled_A2_PDP"/>
        <assertEquals stepKey="assertZDisabled_A2_PDP">
            <expectedResult type="string">true</expectedResult>
            <actualResult type="string">{$grabZDisabled_A2_PDP}</actualResult>
        </assertEquals>
        <!-- Repeat Step 6: Click X swatch -->
        <actionGroup ref="StorefrontSelectSwatchOptionOnProductPageWithScrollAndHoverActionGroup" stepKey="selectSwatchX_PDP">
            <argument name="optionName" value="X"/>
        </actionGroup>
        <!-- Step 6 Expected Result on PDP: Swatches B, 3, Z are crossed -->
        <grabAttributeFrom selector="{{StorefrontProductInfoMainSection.swatchOptionByLabel('B')}}" userInput="disabled" stepKey="grabBDisabled_A2X_PDP"/>
        <assertEquals stepKey="assertBDisabled_A2X_PDP">
            <expectedResult type="string">true</expectedResult>
            <actualResult type="string">{$grabBDisabled_A2X_PDP}</actualResult>
        </assertEquals>
        <grabAttributeFrom selector="{{StorefrontProductInfoMainSection.swatchOptionByLabel('3')}}" userInput="disabled" stepKey="grab3Disabled_A2X_PDP"/>
        <assertEquals stepKey="assert3Disabled_A2X_PDP">
            <expectedResult type="string">true</expectedResult>
            <actualResult type="string">{$grab3Disabled_A2X_PDP}</actualResult>
        </assertEquals>
        <grabAttributeFrom selector="{{StorefrontProductInfoMainSection.swatchOptionByLabel('Z')}}" userInput="disabled" stepKey="grabZDisabled_A2X_PDP"/>
        <assertEquals stepKey="assertZDisabled_A2X_PDP">
            <expectedResult type="string">true</expectedResult>
            <actualResult type="string">{$grabZDisabled_A2X_PDP}</actualResult>
        </assertEquals>
        <!-- Repeat Step 7: Click on the 1 -->
        <actionGroup ref="StorefrontSelectSwatchOptionOnProductPageWithScrollAndHoverActionGroup" stepKey="selectSwatch1_PDP">
            <argument name="optionName" value="1"/>
        </actionGroup>
        <!-- Step 7 Expected Result on PDP: Swatch B is crossed -->
        <grabAttributeFrom selector="{{StorefrontProductInfoMainSection.swatchOptionByLabel('B')}}" userInput="disabled" stepKey="grabBDisabled_A1X_PDP"/>
        <assertEquals stepKey="assertBDisabled_A1X_PDP">
            <expectedResult type="string">true</expectedResult>
            <actualResult type="string">{$grabBDisabled_A1X_PDP}</actualResult>
        </assertEquals>
    </test>
</tests>
